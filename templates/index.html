<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncAuth - Syncthing Credential Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <!-- Axios for API requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>SyncAuth</h1>
            <nav>
                <a href="#master-section">Master</a>
                <a href="#credentials-section">Credentials</a>
                <a href="#devices-section">Devices</a>
                <a href="{{ url_for('logout') }}" id="logout-btn">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container" x-data="syncAuthApp">
        <!-- Status message for DB -->
        {% if db_status and db_status.status != 'ok' %}
        <div class="alert {% if db_status.status == 'error' %}error{% elif db_status.status == 'needs_key' %}error{% elif db_status.status == 'encrypted_or_corrupt' %}error{% elif db_status.status == 'unencrypted' %}warning{% endif %}">
            <h3>Database Status: {{ db_status.status|title }}</h3>
            <p>{{ db_status.message }}</p>
        </div>
        {% endif %}

        <!-- Master Configuration Section -->
        <section id="master-section" class="card">
            <h2>Master Configuration</h2>
            <div id="master-status" class="status-message" style="display: none;"></div>
            
            <form id="master-form" @submit.prevent="saveMasterConfig">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label for="master-address">Master Address:</label>
                    <input type="text" id="master-address" name="address" placeholder="https://syncthing-master:8384" x-model="masterConfig.address" required>
                </div>
                <div class="form-group">
                    <label for="master-api-key">API Key:</label>
                    <input type="password" id="master-api-key" name="api_key" placeholder="{{ '[API Key Set]' if master and master.api_key else 'Enter API Key' }}" x-model="masterConfig.apiKey">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn secondary" @click="testMasterConnection">Test Connection</button>
                    <button type="submit" class="btn primary">Save</button>
                </div>
            </form>
        </section>

        <!-- Credentials Sync Section -->
        <section id="credentials-section" class="card">
            <h2>Credentials Synchronization</h2>
            <div id="sync-status" class="status-message" style="display: none;" x-html="statusMessages.sync"></div>
            
            <form id="credentials-form" @submit.prevent="syncCredentials">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-actions">
                    <button type="submit" class="btn primary">Sync Credentials to All Enabled Clients</button>
                </div>
            </form>
        </section>

        <!-- Devices Section -->
        <section id="devices-section" class="card">
            <div class="section-header">
                <h2>Unified Device View</h2>
                <div class="actions">
                    <button id="refresh-devices" class="btn secondary" @click="loadAllDevices">Refresh Devices</button>
                    <button id="discover-devices" class="btn primary" @click="discoverDevices">Discover Devices</button>
                    <button id="add-client-btn" class="btn success" @click="openModal('client')">Add Client</button>
                </div>
            </div>
            
            <div id="devices-status" class="status-message" style="display: none;" x-html="statusMessages.devices"></div>
            
            <table id="devices-table" class="data-table">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>Name</th>
                        <th>Address</th>
                        <th>Client</th>
                        <th>Sync Enabled</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-if="!devices || devices.length === 0">
                        <tr>
                            <td colspan="6" class="text-center">No devices found</td>
                        </tr>
                    </template>
                    <template x-for="device in devices" :key="device.deviceID">
                        <tr>
                            <td x-text="device.deviceID || ''"></td>
                            <td x-text="device.name || 'Unknown'"></td>
                            <td x-text="device.address || 'N/A'"></td>
                            <td x-text="device.client_id ? '✓' : '✗'"></td>
                            <td x-text="device.sync_enabled ? '✓' : '✗'"></td>
                            <td class="actions">
                                <template x-if="device.client_id">
                                    <div>
                                        <button class="btn" :class="device.sync_enabled ? 'danger' : 'primary'" 
                                                @click="toggleClientSync(device.client_id, !device.sync_enabled)">
                                            <span x-text="device.sync_enabled ? 'Disable Sync' : 'Enable Sync'"></span>
                                        </button>
                                        <button class="btn secondary" @click="editClient(device.client_id)">Edit</button>
                                        <button class="btn danger" @click="deleteClient(device.client_id)">Delete</button>
                                    </div>
                                </template>
                                <template x-if="!device.client_id">
                                    <button class="btn primary" @click="enableSyncForDevice(device.address || '', device.deviceID, device.name)">
                                        Enable Sync
                                    </button>
                                </template>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </section>

        <!-- Client Modal -->
        <div id="client-modal" class="modal" :class="{ 'active': modals.client }">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="client-modal-title" x-text="editingClientId ? 'Edit Client' : 'Add Client'"></h3>
                    <button type="button" class="modal-close" @click="closeModal('client')">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="client-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="client-id" name="id" x-model="clientForm.id">
                        <div class="form-group">
                            <label for="client-label">Label:</label>
                            <input type="text" id="client-label" name="label" x-model="clientForm.label" required>
                        </div>
                        <div class="form-group">
                            <label for="client-device-id">Device ID:</label>
                            <input type="text" id="client-device-id" name="device_id" x-model="clientForm.deviceId" required>
                        </div>
                        <div class="form-group">
                            <label for="client-address">Address:</label>
                            <input type="text" id="client-address" name="address" x-model="clientForm.address" required>
                        </div>
                        <div class="form-group">
                            <label for="client-api-key">API Key:</label>
                            <input type="password" id="client-api-key" name="api_key" x-model="clientForm.apiKey" required>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="client-sync-enabled" name="sync_enabled" x-model="clientForm.syncEnabled">
                                Sync Enabled
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn secondary" id="test-client-connection" @click="testClientConnection">Test Connection</button>
                    <button type="button" class="btn danger" id="cancel-client-edit" @click="closeModal('client')">Cancel</button>
                    <button type="button" class="btn primary" id="save-client" @click="saveClient">Save</button>
                </div>
            </div>
        </div>

        <!-- Combined Modal (Address + API Key) -->
        <div id="combined-modal" class="modal" :class="{ 'active': modals.combined }">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Configure Device: <span id="combined-device-name" x-text="combinedModal.deviceName"></span></h3>
                    <button type="button" class="modal-close" @click="closeModal('combined')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="combined-address">Address:</label>
                        <input type="text" id="combined-address" x-model="combinedModal.address" placeholder="e.g. https://192.168.1.100:8384">
                        <div id="combined-address-suggestions" x-show="combinedModal.addressSuggestions.length > 0">
                            <p>Detected addresses:</p>
                            <div id="combined-address-buttons">
                                <template x-for="(addr, index) in combinedModal.addressSuggestions" :key="index">
                                    <button type="button" class="btn secondary address-suggestion" 
                                            @click="combinedModal.address = addr.value" 
                                            x-text="addr.display || addr.value"></button>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="combined-api-key">API Key:</label>
                        <input type="password" id="combined-api-key" x-model="combinedModal.apiKey" placeholder="Enter API Key">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn secondary" id="test-combined-connection" @click="testCombinedConnection">Test Connection</button>
                    <button type="button" class="btn danger" id="cancel-combined" @click="closeModal('combined')">Cancel</button>
                    <button type="button" class="btn primary" id="confirm-combined" @click="confirmCombined">Confirm</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>SyncAuth - Syncthing Credential Manager</p>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
